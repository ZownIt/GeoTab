"use strict";geotab.addin.startStop=function(){var d,r,i,o,l,c,s,u,n,h=2e3,v=.1,m=function(t){n=t,d.call("Get",{typeName:"Device",search:{groups:r.getGroupFilter(),fromDate:(new Date).toISOString()},resultsLimit:1e3},function(e){e=e.sort(function(e,t){return e.name.toLowerCase().localeCompare(t.name.toLowerCase())}).map(function(e){return{name:e.name,id:e.id}});n===t&&n(e)},function(e){alert(e)})};function f(n,a,r){return new Promise(function(e,t){d.call("Get",{typeName:"Trip",search:{deviceSearch:{id:n},fromDate:a,toDate:r},resultsLimit:1e4},e,t)})}function g(e,t,n,a){n*=t/1e3/60;a=a||"",i=document.getElementById("stopStart-times"+a),o=document.getElementById("stopStart-idling"+a),l=document.getElementById("stopStart-fuel"+a),-1===e?(i.innerText="-",o.innerText="-:--",l.innerText="-"):(i.innerText=Math.round(e),o.innerText=function(e){var t=parseInt(e,10),e=Math.floor(t/3600),t=Math.floor((t-3600*e)/60);t<10&&(t="0"+t);return e+":"+t}(t/1e3),l.innerText=Math.round(n*c*100)/100)}function p(e,t,n){g(e,t,n,"-annual")}function D(){g(-1),p(-1),""!==this.value&&function(i){document.getElementById("stopStart-vehicleSelect").disabled=!0;var o=new Date,l=new Date;l.setDate(o.getDate()-1);var c=0,s=0,u=0;t(30,function(n){var t,a,r;t=i,a=l,r=o,new Promise(function(p,e){d.multiCall([["Get",{typeName:"StatusData",search:{deviceSearch:{id:t},fromDate:a.toISOString(),toDate:r.toISOString()},resultsLimit:5e4}],["Get",{typeName:"LogRecord",search:{deviceSearch:{id:t},fromDate:a,toDate:r},resultsLimit:5e4}]],function(e){var t,n,a,r=e[0],e=e[1],i=!1,o=!1,l=!1,c=null,s=null,u=null,d=0,m=0,f=[],g=r.filter(function(e){switch(e.diagnostic.id){case"DiagnosticVehicleActiveId":case"DiagnosticEngineSpeedId":case"DiagnosticTotalTripIdleFuelUsedId":return!0;default:return!1}});for((g=(g=g.concat(e)).map(function(e){return e.dateTime=new Date(e.dateTime),e})).sort(function(e,t){return e.dateTime-t.dateTime}),n=0;n<g.length;n++){if((t=g[n]).diagnostic)switch(t.diagnostic.id){case"DiagnosticVehicleActiveId":i=1===t.data;break;case"DiagnosticEngineSpeedId":o=0<t.data;break;case"DiagnosticTotalTripIdleFuelUsedId":m+=t.data}else l=0!==t.speed;null===(u=!l&&o&&null==u?t.dateTime:u)||!l&&o||(d+=t.dateTime-u,u=null),!i||o||a?!a||i&&!o||(s=t.dateTime,h<s-c&&f.push({fromDate:c,duration:s-c}),a=!1):(a=!0,c=t.dateTime)}p({fuelUsedPerMinuteIdling:0<d&&v<m?m/(d/1e3/60):0,stopStarts:f})},e)}).then(function(e){var t=e.stopStarts,e=e.fuelUsedPerMinuteIdling;0<(s+=t.length)&&(t.forEach(function(e){c+=e.duration}),g(s,c,u=0<e?0===u?e:(u+e)/2:u)),l.setDate(l.getDate()-1),o.setDate(o.getDate()-1),n.next()})},function(){l=new Date,o=new Date,l.setDate(l.getDate()-30),f(i,l,o).then(function(e){var n,a,r=0;e.forEach(function(e){r+=e.distance}),0<r?(p((n=s/r)*r,(a=c/r)*r,u),t(11,function(t){f(i,l,o).then(function(e){e.forEach(function(e){r+=e.distance}),p(n*r,a*r,u),l.setDate(l.getDate()-30),o.setDate(o.getDate()-30),t.next()})},function(){document.getElementById("stopStart-vehicleSelect").disabled=!1})):document.getElementById("stopStart-vehicleSelect").disabled=!1})})}(this.value)}function t(e,t,n){var a=0,r=!1,i={next:function(){r||(a<e?(a++,t(i)):(r=!0,n()))},iteration:function(){return a-1},break:function(){r=!0,n()}};return i.next(),i}return{initialize:function(e,t,n){d=e,r=t,u=document.getElementById("startStop"),r.translate&&r.translate(u||""),n()},focus:function(e,t){var n,a;d=e,r=t,g(-1),n=function(){var t;t=function(){var e,t,n,a,r,i,o;document.getElementById("stopStart-volume-label").innerHTML=s,document.getElementById("stopStart-volume-label-annual").innerHTML=s,r=460-(a=60)-(t=30),i=400-(e=10)-(n=30),o=d3.select("#my_dataviz").append("svg").attr("width",r+a+t).attr("height",i+e+n).append("g").attr("transform","translate("+a+","+e+")"),d3.csv("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/connectedscatter.csv",function(e){return{date:d3.timeParse("%Y-%m-%d")(e.date),value:e.value}},function(e){var t=d3.scaleTime().domain(d3.extent(e,function(e){return e.date})).range([0,r]);o.append("g").attr("transform","translate(0,"+i+")").call(d3.axisBottom(t));var n=d3.scaleLinear().domain([8e3,9200]).range([i,0]);o.append("g").call(d3.axisLeft(n)),o.append("path").datum(e).attr("fill","none").attr("stroke","#69b3a2").attr("stroke-width",1.5).attr("d",d3.line().x(function(e){return t(e.date)}).y(function(e){return n(e.value)})),o.append("g").selectAll("dot").data(e).enter().append("circle").attr("cx",function(e){return t(e.date)}).attr("cy",function(e){return n(e.value)}).attr("r",5).attr("fill","#69b3a2"),console.log(e)}),console.log("updateDashboardRegionalUnits"),u.style.display="none"},d.getSession(function(e){e=e.userName;d.call("Get",{typeName:"User",search:{name:e}},function(e){if(0===e.length)throw new Error("Unable to find currently logged on user.");e=e[0];switch(e.fuelEconomyUnit){case"LitersPer100Km":case"KmPerLiter":c=1,s=r.translate("Liters");break;case"MPGUS":c=1/3.785411784,s=r.translate("Gallons (US)");break;case"MPGImperial":c=1/4.54609,s=r.translate("Gallons (UK)");break;default:c=1,s=r.translate("Liters")}console.log(e.isMetric),console.log(e.fuelEconomyUnit),console.log(e.language),console.log(e.dateFormat),console.log(e.timeZoneId),t()},function(e){throw"Error while trying to load currently logged on user. "+e})})},(a=document.getElementById("stopStart-vehicleSelect")).innerHTML="",a.removeEventListener("change",D),a.appendChild(((t=document.createElement("option")).default=!0,t.selected=!0,t.value="",t.textContent=r.translate("Select a vehicle..."),t)),m(function(e){e.forEach(function(e){var t=document.createElement("option");t.value=e.id,t.textContent=e.name,a.appendChild(t)}),a.addEventListener("change",D),n()})},blur:function(){u.style.display="none"}}};